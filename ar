#!/bin/bash

GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

SAVE_TO_FILE=false
OUTPUT_FILE="$HOME/structure.txt"

list_dir() {
    local dir_path="$1"
    local indent="$2"
    local prefix="$3"
    local output_var="$4"
    
    local items=($(ls -1 "$dir_path" 2>/dev/null))
    local count=${#items[@]}
    local i=0
    local result=""
    
    for item in "${items[@]}"; do
        i=$((i + 1))
        local full_path="$dir_path/$item"
        local is_last=false
        
        if [ $i -eq $count ]; then
            is_last=true
        fi
        
        if [ "$SAVE_TO_FILE" = true ]; then
            if [ "$is_last" = true ]; then
                line="${indent}${prefix}└── $item"
                new_prefix="    "
            else
                line="${indent}${prefix}├── $item"
                new_prefix="│   "
            fi
        else
            if [ "$is_last" = true ]; then
                line="${indent}${prefix}└── $(get_colored_name "$full_path")"
                new_prefix="    "
            else
                line="${indent}${prefix}├── $(get_colored_name "$full_path")"
                new_prefix="│   "
            fi
        fi
        
        echo -e "$line"
        
        if [ "$SAVE_TO_FILE" = true ]; then
            local clean_line=$(echo -e "$line" | sed 's/\x1b\[[0-9;]*m//g')
            result="${result}${clean_line}\n"
        fi
        
        if [ -d "$full_path" ]; then
            if [ "$SAVE_TO_FILE" = true ]; then
                list_dir "$full_path" "$indent$new_prefix" "" "sub"
            else
                list_dir "$full_path" "$indent$new_prefix" ""
            fi
        fi
    done
    
    if [ "$SAVE_TO_FILE" = true ] && [ "$output_var" != "sub" ]; then
        echo -e "$result"
    fi
}

get_colored_name() {
    local path="$1"
    local name=$(basename "$path")
    
    if [ -d "$path" ]; then
        echo -e "${BLUE}${name}/${NC}"
    elif [ -x "$path" ]; then
        echo -e "${GREEN}${name}*${NC}"
    else
        echo -e "${YELLOW}${name}${NC}"
    fi
}

show_help() {
    echo "Использование: $0 [-f] [директория]"
    echo ""
    echo "Опции:"
    echo "  -f        Сохранить структуру в файл $HOME/structure.txt"
    echo "  -h        Показать эту справку"
    echo ""
    echo "Примеры:"
    echo "  $0                     Показать текущую директорию"
    echo "  $0 -f                  Показать и сохранить текущую директорию"
    echo "  $0 /home/user/         Показать указанную директорию"
    echo "  $0 -f /home/user/      Показать и сохранить указанную директорию"
}

main() {
    local target_dir=""
    
    while getopts "fh" opt; do
        case $opt in
            f)
                SAVE_TO_FILE=true
                ;;
            h)
                show_help
                exit 0
                ;;
            \?)
                echo "Неизвестная опция: -$OPTARG" >&2
                show_help
                exit 1
                ;;
        esac
    done
    
    shift $((OPTIND-1))
    
    if [ $# -eq 0 ]; then
        target_dir="."
    else
        target_dir="$1"
    fi
    
    if [ ! -d "$target_dir" ]; then
        echo -e "${RED}Ошибка: Директория '$target_dir' не существует${NC}"
        exit 1
    fi
    
    target_dir=$(realpath "$target_dir")
    
    echo -e "${GREEN}Содержимое: ${target_dir}/${NC}"
    echo -e "${GREEN}├── $(basename "$target_dir")/${NC}"
    
    if [ "$SAVE_TO_FILE" = true ]; then
        local temp_file=$(mktemp)
        
        echo "Содержимое: $target_dir/" > "$temp_file"
        echo "├── $(basename "$target_dir")/" >> "$temp_file"
        
        {
            list_dir "$target_dir" "" "│   "
        } | tee -a "$temp_file"
        
        cp "$temp_file" "$OUTPUT_FILE"
        rm "$temp_file"
        
        echo -e "${GREEN}✓ Структура сохранена в ${OUTPUT_FILE}${NC}"
    else
        list_dir "$target_dir" "" "│   "
    fi
}

main "$@"
